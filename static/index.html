<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cactus Flasher - ESP32 Web Flasher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        cactus: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="dark bg-gray-900 text-gray-100 min-h-screen">
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-8 w-full max-w-md shadow-2xl border border-gray-700">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-cactus-400">Cactus Flasher</h1>
                <p class="text-gray-400 mt-2">ESP32 Web Flasher</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                    <input type="text" id="login-username"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-cactus-500 focus:border-transparent"
                           placeholder="admin" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                    <input type="password" id="login-password"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-cactus-500 focus:border-transparent"
                           placeholder="********" required>
                </div>
                <div id="login-error" class="text-red-400 text-sm hidden"></div>
                <button type="submit"
                        class="w-full py-2 bg-cactus-600 hover:bg-cactus-700 rounded-lg font-medium transition-colors">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üåµ</span>
                    <h1 class="text-xl font-bold text-cactus-400">Cactus Flasher</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="current-user" class="text-gray-400"></span>
                    <button id="logout-btn" class="px-3 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6">
            <!-- Tabs -->
            <div class="flex space-x-1 mb-6 bg-gray-800 p-1 rounded-lg w-fit">
                <button data-tab="boards" class="tab-btn active px-4 py-2 rounded-md transition-colors">
                    Boards
                </button>
                <button data-tab="upload" class="tab-btn px-4 py-2 rounded-md transition-colors">
                    Upload & Flash
                </button>
                <button data-tab="builds" class="tab-btn px-4 py-2 rounded-md transition-colors">
                    Builds
                </button>
                <button data-tab="settings" class="tab-btn px-4 py-2 rounded-md transition-colors">
                    Settings
                </button>
                <button data-tab="guide" class="tab-btn px-4 py-2 rounded-md transition-colors">
                    Guide
                </button>
            </div>

            <!-- Boards Tab -->
            <div id="tab-boards" class="tab-content">
                <!-- Port Reference (top) -->
                <div class="mb-4 bg-gray-800/50 rounded-lg p-3 border border-gray-700/50 flex items-center justify-between">
                    <h4 class="text-sm font-medium text-gray-400">Port Reference (Board ID = XX)</h4>
                    <div class="flex flex-wrap gap-4 text-sm">
                        <span><span class="port-badge web">WEB</span> <span class="text-gray-400">80XX</span> - Webserver</span>
                        <span><span class="port-badge ota">OTA</span> <span class="text-gray-400">82XX</span> - Firmware updates</span>
                        <span><span class="port-badge api">API</span> <span class="text-gray-400">60XX</span> - ESPHome Native API</span>
                    </div>
                </div>

                <!-- Header: title + action buttons -->
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Registered Boards</h2>
                    <div class="space-x-2">
                        <div class="tooltip-wrapper inline-block">
                            <button id="scan-boards-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                                Scan All
                            </button>
                            <span class="tooltip-text tooltip-wide">Check all registered boards for online/offline status (OTA, Web, API ports)</span>
                        </div>
                        <div class="tooltip-wrapper inline-block">
                            <button id="discover-boards-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                                Discover
                            </button>
                            <span class="tooltip-text tooltip-wide">Probe OTA ports 8201-8299 on the network to find unregistered boards</span>
                        </div>
                        <div class="tooltip-wrapper inline-block">
                            <button id="add-board-btn" class="px-4 py-2 bg-cactus-600 hover:bg-cactus-700 rounded-lg transition-colors">
                                Add Board
                            </button>
                            <span class="tooltip-text">Manually register a new ESP32 board</span>
                        </div>
                    </div>
                </div>

                <!-- Board Cards Grid -->
                <div id="boards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Board cards will be inserted here -->
                </div>

                <!-- Log Panels Container: Board Ops Log (always) + Live Logs (when streaming) -->
                <div id="log-panels-container" class="mt-6 flex gap-4">
                    <!-- Board Operations Log (always visible, full-width default) -->
                    <div id="ops-log-panel" class="flex-1 bg-gray-800 rounded-xl p-4 border border-gray-700 min-w-0">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-semibold">Board Operations Log</h2>
                            <div class="flex items-center space-x-2">
                                <button id="maximize-ops-log-btn" class="text-gray-500 hover:text-white text-sm hidden" title="Toggle maximize">&#x26F6;</button>
                                <button id="save-boards-console-btn" class="text-sm text-gray-400 hover:text-white" title="Download log as TXT">Save</button>
                                <button id="clear-boards-console-btn" class="text-sm text-gray-400 hover:text-white">Clear</button>
                            </div>
                        </div>
                        <div id="boards-console-output" class="console-panel bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm">
                            <p class="text-gray-500">Ready...</p>
                        </div>
                    </div>

                    <!-- Live Logs Panel (hidden until streaming, appears as right panel) -->
                    <div id="live-logs-panel" class="flex-1 bg-gray-800 rounded-xl p-4 border border-gray-700 min-w-0 hidden">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold flex items-center">
                                <span class="live-dot"></span>
                                Live Logs: <span id="live-logs-board-name" class="text-cactus-400 ml-1"></span>
                                <span id="live-logs-count" class="text-gray-500 text-xs ml-2"></span>
                            </h3>
                            <div class="flex items-center space-x-2">
                                <button id="maximize-live-logs-btn" class="text-gray-500 hover:text-white text-sm" title="Toggle maximize">&#x26F6;</button>
                                <select id="live-logs-filter" class="px-2 py-1 text-xs bg-gray-700 border border-gray-600 rounded">
                                    <option value="all">All events</option>
                                    <option value="sensor">Sensors only</option>
                                    <option value="switch">Switches/Lights</option>
                                    <option value="binary">Binary sensors</option>
                                    <option value="text">Text sensors</option>
                                    <option value="log">Logs only</option>
                                </select>
                                <button id="download-live-logs-btn" class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 rounded transition-colors" title="Download logs as TXT">Save</button>
                                <button id="stop-live-logs-btn" class="px-3 py-1 text-xs bg-red-900 hover:bg-red-800 rounded transition-colors">Stop</button>
                            </div>
                        </div>
                        <div id="live-logs-output" class="console-panel bg-gray-900 rounded-lg p-3 h-64 overflow-y-auto font-mono text-xs">
                        </div>
                    </div>
                </div>

                <!-- Connection History (collapsible, collapsed by default) -->
                <div class="mt-6 bg-gray-800 rounded-xl border border-gray-700">
                    <div class="flex items-center justify-between p-4">
                        <button id="toggle-status-log" class="flex items-center space-x-2 text-left hover:text-white transition-colors">
                            <span id="status-log-chevron" class="text-gray-400 transition-transform text-xs" style="transform: rotate(-90deg)">&#9660;</span>
                            <h2 class="text-xl font-semibold">Connection History</h2>
                        </button>
                        <div class="flex items-center space-x-3">
                            <button id="refresh-status-log-btn" class="text-sm text-gray-400 hover:text-white" title="Refresh">&#x21BB;</button>
                            <button id="clear-all-status-log-btn" class="text-red-500 hover:text-red-400 text-sm" title="Clear all connection history">&#x1F5D1;</button>
                        </div>
                    </div>
                    <div id="status-log-body" class="px-6 pb-6 hidden">
                        <div id="status-log-container" class="max-h-64 overflow-y-auto">
                            <p class="text-gray-500 text-sm">No status changes recorded yet. Run a scan to start tracking.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload & Flash Tab -->
            <div id="tab-upload" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Upload Panel -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Upload Firmware</h2>

                        <!-- Project Type Selector -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Project Type</label>
                            <div class="flex space-x-2">
                                <button data-type="binary" class="project-type-btn active flex-1 py-2 rounded-lg border border-gray-600 transition-colors">
                                    Binary (.bin)
                                </button>
                                <button data-type="esphome" class="project-type-btn flex-1 py-2 rounded-lg border border-gray-600 transition-colors">
                                    ESPHome
                                </button>
                                <button data-type="arduino" class="project-type-btn flex-1 py-2 rounded-lg border border-gray-600 transition-colors">
                                    Arduino
                                </button>
                                <button data-type="platformio" class="project-type-btn flex-1 py-2 rounded-lg border border-gray-600 transition-colors">
                                    PlatformIO
                                </button>
                            </div>
                        </div>

                        <!-- Drop Zone -->
                        <div id="drop-zone" class="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center hover:border-cactus-500 transition-colors cursor-pointer">
                            <div class="text-4xl mb-2">üìÅ</div>
                            <p class="text-gray-400">Drag & drop files here or click to browse</p>
                            <p id="file-hint" class="text-sm text-gray-500 mt-1">.bin firmware file</p>
                            <input type="file" id="file-input" class="hidden" accept=".bin">
                        </div>

                        <div id="selected-files" class="mt-4 hidden">
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span id="selected-files-count" class="text-sm font-medium"></span>
                                    <button id="clear-file-btn" class="text-gray-400 hover:text-white text-sm">Clear all</button>
                                </div>
                                <div id="selected-files-list" class="space-y-1 text-sm text-gray-300 max-h-32 overflow-y-auto">
                                    <!-- File entries will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Target Board Selector -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Target Board</label>
                            <select id="target-board" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                                <option value="">Select a board...</option>
                            </select>
                        </div>

                        <!-- Flash Button -->
                        <button id="flash-btn" disabled
                                class="w-full mt-4 py-3 bg-cactus-600 hover:bg-cactus-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-medium transition-colors">
                            Flash Firmware
                        </button>
                    </div>

                    <!-- Console Panel -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold">Console</h2>
                            <div class="flex items-center space-x-2">
                                <button id="save-console-btn" class="text-sm text-gray-400 hover:text-white" title="Download log as TXT">
                                    Save
                                </button>
                                <button id="clear-console-btn" class="text-sm text-gray-400 hover:text-white">
                                    Clear
                                </button>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div id="progress-container" class="mb-4 hidden">
                            <div class="flex items-center justify-between text-sm mb-1">
                                <span id="progress-status">Uploading...</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="progress-bar" class="bg-cactus-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Console Output -->
                        <div id="console-output" class="console-panel bg-gray-900 rounded-lg p-4 h-80 overflow-y-auto font-mono text-sm">
                            <p class="text-gray-500">Ready to flash...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Builds Tab -->
            <div id="tab-builds" class="tab-content hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Build History</h2>
                    <button id="refresh-builds-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                        Refresh
                    </button>
                </div>
                <div id="builds-list" class="space-y-3">
                    <!-- Build items will be inserted here -->
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content hidden">
                <div class="max-w-2xl space-y-6">
                    <!-- User Management -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">User Management</h3>

                        <!-- User List -->
                        <div id="users-list" class="mb-6">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-700">
                                        <th class="text-left py-2 text-gray-400">Username</th>
                                        <th class="text-left py-2 text-gray-400">Created</th>
                                        <th class="text-left py-2 text-gray-400">Password Changed</th>
                                        <th class="text-right py-2 text-gray-400">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Users will be rendered here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Register New User -->
                        <div class="border-t border-gray-700 pt-4 mb-4">
                            <h4 class="text-sm font-semibold text-gray-300 mb-3">Register New User</h4>
                            <form id="register-user-form" class="space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <input type="text" id="reg-username" placeholder="Username"
                                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm" required>
                                    </div>
                                    <div>
                                        <input type="password" id="reg-password" placeholder="Password"
                                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm" required>
                                    </div>
                                </div>
                                <div>
                                    <input type="password" id="reg-password-confirm" placeholder="Confirm Password"
                                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm" required>
                                </div>
                                <div id="reg-password-strength" class="text-xs hidden"></div>
                                <div id="reg-error" class="text-red-400 text-xs hidden"></div>
                                <button type="submit" class="px-4 py-2 bg-cactus-600 hover:bg-cactus-700 rounded-lg text-sm transition-colors">
                                    Register User
                                </button>
                            </form>
                        </div>

                        <!-- Change Password -->
                        <div class="border-t border-gray-700 pt-4">
                            <h4 class="text-sm font-semibold text-gray-300 mb-3">Change Your Password</h4>
                            <form id="change-password-form" class="space-y-3">
                                <div>
                                    <input type="password" id="cp-old-password" placeholder="Current Password"
                                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm" required>
                                </div>
                                <div>
                                    <input type="password" id="cp-new-password" placeholder="New Password"
                                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm" required>
                                </div>
                                <div>
                                    <input type="password" id="cp-new-password-confirm" placeholder="Confirm New Password"
                                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm" required>
                                </div>
                                <div id="cp-password-strength" class="text-xs hidden"></div>
                                <div id="cp-error" class="text-red-400 text-xs hidden"></div>
                                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-colors">
                                    Change Password
                                </button>
                            </form>
                        </div>

                        <!-- Password Requirements -->
                        <div class="mt-4 p-3 bg-gray-900 rounded-lg text-xs text-gray-500">
                            Password requirements: min 8 characters, 1 uppercase, 1 lowercase, 1 digit, 1 special character (!@#$%^&*...)
                        </div>
                    </div>

                    <!-- DDNS Settings -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">Network Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">DDNS Host</label>
                                <input type="text" id="ddns-host" value="esp32gb.ddns.net"
                                       class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-cactus-500">
                            </div>
                        </div>
                    </div>

                    <!-- Add Board Form -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">Add New Board</h3>
                        <form id="add-board-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Board Name</label>
                                    <input type="text" id="board-name" placeholder="cactus-sentinel"
                                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Board ID (01-99)</label>
                                    <input type="number" id="board-id" min="1" max="99" placeholder="88"
                                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Board Type</label>
                                    <select id="board-type" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                                        <option value="esp32">ESP32</option>
                                        <option value="esp32s2">ESP32-S2</option>
                                        <option value="esp32s3">ESP32-S3</option>
                                        <option value="esp32c3">ESP32-C3</option>
                                        <option value="esp8266">ESP8266</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Custom Host (optional)</label>
                                    <input type="text" id="board-host" placeholder="Leave empty to use DDNS"
                                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Hostname (optional)</label>
                                <input type="text" id="board-hostname" placeholder="Auto-generated if empty (e.g. sentinel-88.esp32gb.ddns.net)"
                                       class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">MAC Address (optional)</label>
                                    <input type="text" id="board-mac" placeholder="AA:BB:CC:DD:EE:FF"
                                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                                           pattern="^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">API Encryption Key (optional)</label>
                                    <input type="password" id="board-api-key" placeholder="ESPHome native API key"
                                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Web Username (optional)</label>
                                    <input type="text" id="board-web-username" placeholder="ESPHome web_server username"
                                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Web Password (optional)</label>
                                    <input type="password" id="board-web-password" placeholder="ESPHome web_server password"
                                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                                </div>
                            </div>
                            <button type="submit" class="px-4 py-2 bg-cactus-600 hover:bg-cactus-700 rounded-lg transition-colors">
                                Add Board
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Guide Tab -->
            <div id="tab-guide" class="tab-content hidden">
                <div class="max-w-3xl space-y-6">

                    <!-- What is Cactus Flasher -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-semibold text-cactus-400 mb-3">What is Cactus Flasher?</h2>
                        <p class="text-gray-300 leading-relaxed">
                            Cactus Flasher is a web-based OTA (Over-The-Air) firmware flasher for ESP32 boards.
                            It allows you to manage, monitor, and update ESP32 devices remotely through a browser interface.
                            The application runs on a VPS and connects to your ESP32 boards via DDNS and port forwarding.
                        </p>
                        <div class="mt-3 p-3 bg-gray-900 rounded-lg text-sm text-gray-400">
                            <strong class="text-gray-300">Key features:</strong> Board management, multi-format firmware flashing (Binary, ESPHome, Arduino, PlatformIO),
                            real-time status monitoring, sensor discovery, connection history logging.
                        </div>
                    </div>

                    <!-- How to Flash Firmware -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-semibold text-cactus-400 mb-3">How to Flash Firmware</h2>
                        <div class="guide-steps space-y-4">
                            <div class="guide-step">
                                <h4 class="font-medium text-gray-200">Select Project Type</h4>
                                <p class="text-gray-400 text-sm">Choose between Binary (.bin), ESPHome (.yaml), Arduino (.ino), or PlatformIO (.zip) depending on your firmware format.</p>
                            </div>
                            <div class="guide-step">
                                <h4 class="font-medium text-gray-200">Upload Firmware Files</h4>
                                <p class="text-gray-400 text-sm">Drag and drop your firmware file(s) into the upload zone, or click to browse. For ESPHome and Arduino, you can include companion/library files.</p>
                            </div>
                            <div class="guide-step">
                                <h4 class="font-medium text-gray-200">Select Target Board</h4>
                                <p class="text-gray-400 text-sm">Choose which ESP32 board to flash from the dropdown. Only online boards can receive OTA updates. You can also click "Flash" directly on a board card.</p>
                            </div>
                            <div class="guide-step">
                                <h4 class="font-medium text-gray-200">Flash & Monitor</h4>
                                <p class="text-gray-400 text-sm">Click "Flash Firmware" and watch the console. For non-binary types, the system will compile first, then flash. The board will reboot automatically after a successful flash.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Project Types -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-semibold text-cactus-400 mb-3">Project Types</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-lg p-4 border border-gray-700/50">
                                <h3 class="text-cactus-400 font-semibold mb-2">Binary (.bin)</h3>
                                <p class="text-gray-400 text-sm">Pre-compiled firmware binary. Upload directly and flash immediately. No compilation needed. Fastest option when you already have a .bin file.</p>
                            </div>
                            <div class="bg-gray-900 rounded-lg p-4 border border-gray-700/50">
                                <h3 class="text-cactus-400 font-semibold mb-2">ESPHome (.yaml)</h3>
                                <p class="text-gray-400 text-sm">Upload a YAML configuration file. Supports companion files (HTML, CSS, JS for web_server component) or a .zip archive. The server compiles it using ESPHome, then flashes.</p>
                            </div>
                            <div class="bg-gray-900 rounded-lg p-4 border border-gray-700/50">
                                <h3 class="text-cactus-400 font-semibold mb-2">Arduino (.ino)</h3>
                                <p class="text-gray-400 text-sm">Upload an Arduino sketch (.ino) with optional library files (.h, .cpp, .c). Compiled using arduino-cli with ESP32 board support, then flashed via OTA.</p>
                            </div>
                            <div class="bg-gray-900 rounded-lg p-4 border border-gray-700/50">
                                <h3 class="text-cactus-400 font-semibold mb-2">PlatformIO (.zip)</h3>
                                <p class="text-gray-400 text-sm">Upload a zipped PlatformIO project containing platformio.ini and source code. The server builds it using PlatformIO CLI, then flashes the resulting binary.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Scan vs Discover -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-semibold text-cactus-400 mb-3">Scan vs Discover</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-900 rounded-lg p-4 border border-blue-900/30">
                                <h3 class="text-blue-400 font-semibold mb-2">Scan All</h3>
                                <ul class="text-gray-400 text-sm space-y-1.5">
                                    <li>Checks <strong class="text-gray-300">all registered boards</strong> in your board list</li>
                                    <li>Tests 3 ports per board: OTA (82XX), Web (80XX), API (60XX)</li>
                                    <li>Reports detailed online/offline status for each board</li>
                                    <li>Auto-discovers MAC address and sensors from online boards</li>
                                    <li>Updates "last seen" timestamps</li>
                                    <li>Logs status transitions in Connection History</li>
                                </ul>
                                <p class="text-blue-400/70 text-xs mt-3">Use this to check the health of your known boards</p>
                            </div>
                            <div class="bg-gray-900 rounded-lg p-4 border border-purple-900/30">
                                <h3 class="text-purple-400 font-semibold mb-2">Discover</h3>
                                <ul class="text-gray-400 text-sm space-y-1.5">
                                    <li>Probes <strong class="text-gray-300">OTA ports 8201-8299</strong> on the DDNS host</li>
                                    <li>Finds boards <strong class="text-gray-300">not yet registered</strong> in your board list</li>
                                    <li>Maps port number back to board ID (port 8288 = board ID 88)</li>
                                    <li>Automatically registers new boards with auto-generated names</li>
                                    <li>Scans in batches of 20 ports to avoid network overload</li>
                                </ul>
                                <p class="text-purple-400/70 text-xs mt-3">Use this to find new boards on your network</p>
                            </div>
                        </div>
                    </div>

                    <!-- Port Convention -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-semibold text-cactus-400 mb-3">Board Port Convention</h2>
                        <p class="text-gray-400 text-sm mb-3">Each board ID (01-99) maps to three dedicated ports:</p>
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left py-2 text-gray-400">Service</th>
                                    <th class="text-left py-2 text-gray-400">Port Formula</th>
                                    <th class="text-left py-2 text-gray-400">Example (ID=88)</th>
                                    <th class="text-left py-2 text-gray-400">Purpose</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-gray-700/50">
                                    <td class="py-2"><span class="port-badge web">WEB</span></td>
                                    <td class="py-2 font-mono text-gray-300">80XX</td>
                                    <td class="py-2 font-mono text-gray-300">8088</td>
                                    <td class="py-2 text-gray-400">Web server / browser access</td>
                                </tr>
                                <tr class="border-b border-gray-700/50">
                                    <td class="py-2"><span class="port-badge ota">OTA</span></td>
                                    <td class="py-2 font-mono text-gray-300">82XX</td>
                                    <td class="py-2 font-mono text-gray-300">8288</td>
                                    <td class="py-2 text-gray-400">OTA firmware updates</td>
                                </tr>
                                <tr>
                                    <td class="py-2"><span class="port-badge api">API</span></td>
                                    <td class="py-2 font-mono text-gray-300">60XX</td>
                                    <td class="py-2 font-mono text-gray-300">6088</td>
                                    <td class="py-2 text-gray-400">ESPHome Native API</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Hostname Convention -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-semibold text-cactus-400 mb-3">Hostname Convention</h2>
                        <p class="text-gray-400 text-sm mb-2">Hostnames are auto-generated from the board name and ID:</p>
                        <div class="bg-gray-900 rounded-lg p-4 font-mono text-sm">
                            <p class="text-gray-300">1. Strip prefix: <span class="text-gray-500">cactus-</span>, <span class="text-gray-500">esp32-</span>, or <span class="text-gray-500">esp-</span></p>
                            <p class="text-gray-300 mt-1">2. Format: <span class="text-cactus-400">{shortname}-{ID:02d}.{DDNS_HOST}</span></p>
                            <p class="text-gray-400 mt-2">Example: <span class="text-gray-300">cactus-sentinel</span> ID 88</p>
                            <p class="text-cactus-400 ml-4">sentinel-88.esp32gb.ddns.net</p>
                        </div>
                        <p class="text-gray-500 text-xs mt-2">Custom hostnames can be set to override auto-generation.</p>
                    </div>

                    <!-- Network Topology -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-semibold text-cactus-400 mb-3">Network Topology</h2>
                        <div class="bg-gray-900 rounded-lg p-4 font-mono text-sm text-center">
                            <div class="space-y-2">
                                <p class="text-blue-400">VPS (Cactus Flasher on port 8000)</p>
                                <p class="text-gray-600">&darr;</p>
                                <p class="text-purple-400">DDNS: esp32gb.ddns.net</p>
                                <p class="text-gray-600">&darr;</p>
                                <p class="text-amber-400">Home Router (port forwarding per board)</p>
                                <p class="text-gray-600">&darr;</p>
                                <p class="text-cactus-400">ESP32 Boards (local network)</p>
                            </div>
                        </div>
                        <p class="text-gray-500 text-xs mt-3">
                            Each board requires port forwarding on your router for its WEB, OTA, and API ports.
                        </p>
                    </div>

                    <!-- Troubleshooting -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-semibold text-cactus-400 mb-3">Troubleshooting</h2>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-medium text-red-400 mb-1">Board shows Offline</h4>
                                <ul class="text-gray-400 text-sm space-y-1 ml-4 list-disc">
                                    <li>Check that the ESP32 is powered on and connected to WiFi</li>
                                    <li>Verify port forwarding rules on your router (OTA port 82XX, Web port 80XX)</li>
                                    <li>Ensure the DDNS hostname resolves correctly</li>
                                    <li>Try pinging the board directly to see which ports respond</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-medium text-red-400 mb-1">Flash Failed</h4>
                                <ul class="text-gray-400 text-sm space-y-1 ml-4 list-disc">
                                    <li>Confirm the board is online (OTA port must respond)</li>
                                    <li>Check that the firmware binary is compatible with the board type</li>
                                    <li>Ensure sufficient space on the ESP32 for the new firmware</li>
                                    <li>Review the console output for specific error messages</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-medium text-red-400 mb-1">Build Failed</h4>
                                <ul class="text-gray-400 text-sm space-y-1 ml-4 list-disc">
                                    <li>Check YAML/sketch syntax for compilation errors</li>
                                    <li>Ensure required build tools are installed (esphome, arduino-cli, platformio)</li>
                                    <li>Review build logs for detailed error messages</li>
                                    <li>For Arduino: verify the FQBN matches your board type</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-medium text-red-400 mb-1">No Sensors Detected</h4>
                                <ul class="text-gray-400 text-sm space-y-1 ml-4 list-disc">
                                    <li>Ensure the board has the ESPHome web_server component enabled</li>
                                    <li>The web server must be accessible on port 80XX</li>
                                    <li>Sensors are discovered during "Scan All" - run a scan first</li>
                                    <li>Check that sensor entities are exposed in your ESPHome config</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Add Board Modal -->
    <div id="add-board-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md border border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Add New Board</h3>
                <button id="close-add-board-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="modal-add-board-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Board Name</label>
                    <input type="text" id="modal-board-name" placeholder="cactus-sentinel"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Board ID (01-99)</label>
                    <input type="number" id="modal-board-id" min="1" max="99" placeholder="88"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Board Type</label>
                    <select id="modal-board-type" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                        <option value="esp32">ESP32</option>
                        <option value="esp32s2">ESP32-S2</option>
                        <option value="esp32s3">ESP32-S3</option>
                        <option value="esp32c3">ESP32-C3</option>
                        <option value="esp8266">ESP8266</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Custom Host (optional)</label>
                    <input type="text" id="modal-board-host" placeholder="Leave empty to use DDNS"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Hostname (optional)</label>
                    <input type="text" id="modal-board-hostname" placeholder="Auto-generated if empty"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">MAC Address (optional)</label>
                    <input type="text" id="modal-board-mac" placeholder="AA:BB:CC:DD:EE:FF"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                           pattern="^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">API Encryption Key (optional)</label>
                    <input type="password" id="modal-board-api-key" placeholder="ESPHome native API key"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Web Username</label>
                        <input type="text" id="modal-board-web-username" placeholder="web_server auth"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Web Password</label>
                        <input type="password" id="modal-board-web-password" placeholder="web_server auth"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button type="button" id="cancel-add-board" class="flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 py-2 bg-cactus-600 hover:bg-cactus-700 rounded-lg transition-colors">
                        Add Board
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Board Modal -->
    <div id="edit-board-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md border border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Edit Board: <span id="edit-board-title" class="text-cactus-400"></span></h3>
                <button id="close-edit-board-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <input type="hidden" id="edit-board-original-name">
            <form id="edit-board-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Board ID (01-99)</label>
                    <input type="number" id="edit-board-id" min="1" max="99"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Board Type</label>
                    <select id="edit-board-type" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                        <option value="esp32">ESP32</option>
                        <option value="esp32s2">ESP32-S2</option>
                        <option value="esp32s3">ESP32-S3</option>
                        <option value="esp32c3">ESP32-C3</option>
                        <option value="esp8266">ESP8266</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Custom Host (optional)</label>
                    <input type="text" id="edit-board-host" placeholder="Leave empty to use DDNS"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Hostname (optional)</label>
                    <input type="text" id="edit-board-hostname" placeholder="Auto-generated if empty"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">MAC Address (optional)</label>
                    <input type="text" id="edit-board-mac" placeholder="AA:BB:CC:DD:EE:FF"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                           pattern="^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">API Encryption Key (optional)</label>
                    <input type="password" id="edit-board-api-key" placeholder="ESPHome native API key"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Web Username</label>
                        <input type="text" id="edit-board-web-username" placeholder="web_server auth"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Web Password</label>
                        <input type="password" id="edit-board-web-password" placeholder="web_server auth"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button type="button" id="cancel-edit-board" class="flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 py-2 bg-cactus-600 hover:bg-cactus-700 rounded-lg transition-colors">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/app.js?v=13"></script>
</body>
</html>
